<!DOCTYPE html>

<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<html>
<style>
  * {
    padding: 0;
    margin: 0;
  }

  table {
    margin: 15px;
  }

  table,
  th,
  td {
    border: 1px solid black;
    border-collapse: collapse;
    padding: 5px 10px;
    text-align: left;
  }

  input,
  select {
    width: 90%;
    border: 0;
  }

  input:focus-visible,
  select:focus-visible {
    outline: none;
  }

  .layer {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 450px;
    height: 450px
  }

  #controlLayer {
    visibility: visible;
  }

  .layer2 {
    position: absolute;
    left: 450px;
    top: 0px;
    width: 450px;
    height: 450px
  }

  #controlLayer {
    visibility: visible;
  }

  .layer3 {
    position: absolute;
    left: 0px;
    top: 350px;
    width: 450px;
    height: 450px
  }

  #controlLayer {
    visibility: visible;
  }

  .layer4 {
    position: absolute;
    left: 450px;
    top: 350px;
    width: 450px;
    height: 450px
  }

  #controlLayer {
    visibility: visible;
  }
</style>

<body>

  <body style="background-color:white;">
    <div style="background-color: rgb(25, 197, 249);padding: 7px;">
      <h5 style="text-align: center;">Layout P&R Dashboard</h5>
    </div>

    <div style="display: flex;">
      <div style="width: 30%;">
        <table style="width: 90%;">
          <thead>
            <tr>
              <th>Reference_Cell</th>
              <th><input placeholder="user_provided_input_cell" /></th>
            </tr>
          </thead>
          <tr>
            <td>library</td>
            <td>
              <div id="library_div">
            </td>
          </tr>
          <tr>
            <td>family</td>
            <td>
              <div id="family_div">
            </td>
          </tr>

          <tr>
            <td>Cells</td>
            <td>
              <div id="cells_div"></div>
            </td>
          </tr>

        </table>

        <table style="width: 90%;margin-top: 50px; position:relative" id="layer_table">

        </table>
      </div>

      <div style="width: 90%;margin-top: 50px; position:relative" id="layers_chart">
      </div>
    </div>


    <script>
      let masterData = [];
      $(document).ready(function () {
        $.ajax({
          url: "/init"
        }).then((data) => {
          masterData = data;
          renderHtml();
        });
      });

      function renderHtml() {
        showLibrary();
        showFamilies();
        showCells();
      }

      function getLibraryById(libId) {
        return libId in masterData ? libId : false;
      }

      function showLibrary() {
        let libraries = Object.keys(masterData);
        let htmlString = `<select name="All" id="library" onchange="onChangeLibrary(this)">
                          <option value="">All</option>`;
        for (let i = 0; i < libraries.length; i++) {
          htmlString += `<option value="${libraries[i]}">${libraries[i]}</option>`
        }
        htmlString += '</select>';
        $("#library_div").html(htmlString)
      }

      function onChangeLibrary(event) {
        let find = false;
        const libData = getLibraryById(event.value);
        if (libData) {
          showFamilies(event.value, masterData[event.value])
        } else {
          showFamilies();
          showCells();
          resetView();
        }

      }

      function showFamilies(libId = '', familyData = []) {
        let htmlString = `<select id="families" onchange="onChangeFamily(this)">
                          <option value="">All</option>`;
        for (let i = 0; i < familyData.length; i++) {
          htmlString += `<option value="${libId}||${familyData[i]}">${familyData[i]}</option>`
        }
        htmlString += '</select>';
        $("#family_div").html(htmlString)

      }

      function onChangeFamily(event) {
        const arr = event.value.split("||");
        const libId = arr[0];
        const libData = getLibraryById(libId);
        libData ? fetchCellsList([arr[0] + arr[1]]) : showCells();
      }

      function fetchCellsList(familyIds = []) {
        $.ajax({
          url: "/filter",
          type: 'post',
          data: JSON.stringify({ familyIds }),
          contentType: "application/json; charset=utf-8",
          traditional: true,
        }).then((data) => {
          showCells(data)
        });
      }

      function showCells(cells = {}) {
        const familes = Object.keys(cells);
        let htmlString = `<select id="families" onchange="onChangeCells(this)">
                          <option value="">All</option>`;
        for (let i = 0; i < familes.length; i++) {
          htmlString += `<optgroup label="${familes[i]}">`;
          for (let j = 0; j < cells[familes[i]].length; j++) {
            htmlString += `<option value="${cells[familes[i]][j]}">${cells[familes[i]][j]}</option>`
          }
          htmlString += `    </optgroup>`;
        }
        htmlString += '</select>';
        $("#cells_div").html(htmlString);
      }

      function onChangeCells(event) {
        const libId = event.value.slice(0, 3);
        const libData = getLibraryById(libId);
        libData ? fetchLayers([event.value]) : showLayersOption();
        // libData ? showLayersOption(arr[0], arr[2], libData) : showLayersOption();
      }

      function fetchLayers(cellIds = []) {
        $.ajax({
          url: "/filter",
          type: 'post',
          data: JSON.stringify({ cellIds }),
          contentType: "application/json; charset=utf-8",
          traditional: true,
        }).then((data) => {
          showLayersOption(data);
        });
      }

      function showLayersOption(cells = {}) {
        const cellIds = Object.keys(cells);
        if (cellIds.length) {
          let htmlString = `<tr>
		          <th style="width: 50%;">Layers</th>
              <th style="width: 50%;">Visibility</th>
             </tr>`;
          for (let i = 0; i < cellIds.length; i++) {
            for (let j = 0; j < cells[cellIds[i]].layer.length; j++) {
              const imgPath = cells[cellIds[i]].path + "/" + cellIds[i] + "/" + cells[cellIds[i]].layer[j];
              htmlString += `<tr>
							<td>${cells[cellIds[i]].layer[j]}</td>
							<td>
								<input type="checkbox" class="layer-selector" id="layer_${cellIds[i]}_${i}" img_url="${imgPath}" />
							</td>
						</tr>`
            }
          }
          $("#layer_table").html(htmlString);

          $('input.layer-selector').on('change', function () {
            if (this.checked) {
              addLayer(this.id, $("#" + this.id).attr("img_url"));
            } else {
              removeLayer(this.id);
            }
          });
        }
      }



      function addLayer(id, imageUrl) {
        let htmlString = `<embed id="layer_image_${id}" class="layer" src="${imageUrl}" />`
        $("#layers_chart").append(htmlString);
      }

      function removeLayer(id) {
        $('#layer_image_' + id).remove();
      }

      function resetView() {
        $("#layers_chart").html('');
        $("#layer_table").html('');
      }

    </script>
  </body>

</html>